# Архитектура Экосистемы "Тёплый Дом"
## Описание Компании
"Тёплый дом" — небольшая компания, специализирующаяся на организации удалённого управления отоплением в домах. Недавно компания выиграла тендер на создание экосистемы умных посёлков в нескольких регионах страны. Для выполнения этого заказа необходимо расширить функционал системы и масштабировать её.

## Задание 1. Анализ и планирование

### 1.1 Изучение функциональности монолитного приложения

На текущем этапе система состоит из следующих основных компонентов, каждый из которых отвечает за свою часть функциональности:

* Датчик температуры:
  - Измеряет температуру в реальном времени и предоставляет данные системе.
  - Может быть включён или выключен по запросу.
    
* Модуль управления отоплением:
  - Получает данные о текущей температуре от подключённых датчиков.
  - Позволяет пользователю задавать целевую температуру для отопительных устройств.
  - Взаимодействует с умными устройствами отопления и передаёт команды для их настройки. 
* Умное устройство отопления:
  - Получает указания от модуля управления и регулирует температуру в помещении.
  - Устанавливает и поддерживает целевую температуру.
  - Может быть включено или выключено в зависимости от потребностей.

Система взаимодействует с двумя типами пользователей:
 - Мастер: устанавливает и настраивает оборудование. 
    Пользователь приобретает устройство, приглашает мастера, который приезжает, настраивает устройство и вносит его идентификатор в базу данных системы.
 - Пользователь (владелец дома): управляет устройством через мобильное приложение. Команды пользователя поступают на центральный модуль управления, который передаёт их датчику и отопительному устройству для исполнения.

Этот процесс достаточно трудоёмок и предполагает множество ручных операций, что значительно усложняет масштабирование системы.


### 1.2 Анализ архитектуры монолитного приложения

Монолитная архитектура системы создаёт значительные ограничения, которые мешают развитию и масштабированию.

Текущие характеристики системы:

- Язык программирования: Java
- База данных: PostgreSQL

Архитектура: Монолитная - все компоненты системы (обработка запросов, бизнес-логика, работа с данными) находятся в рамках одного приложения.

Взаимодействие: Синхронное - запросы обрабатываются последовательно.

Масштабируемость: Ограничена, так как монолит сложно масштабировать по частям.

Развёртывание: Требует остановки всего приложения.


### 1.3 Определение доменов и границ контекстов

Для построения новой архитектуры с использованием принципов Domain-Driven Design (DDD), необходимо определить домены и границы контекстов:

Основные домены
- Управление устройствами:
  * Включает все функции, связанные с отправкой команд на умные устройства отопления и их управлением.
  * Основная цель: управление состоянием умных устройств (включение, выключение, регулировка температуры).

- Мониторинг и сбор данных
  * Включает сбор данных о температуре с датчиков и передачу их в центральную систему для анализа.
  * Основная цель: обеспечить пользователей актуальной информацией о температуре в доме.

- Настройка и подключение устройств
  * Включает процесс установки и первичной настройки новых устройств в системе.
  * Основная цель: автоматизировать процесс регистрации и настройки новых устройств без участия специалистов.

- Пользовательский интерфейс
  * Включает взаимодействие с пользователем через мобильное приложение и веб-интерфейс.
  * Основная цель: предоставление пользователям интерфейса для управления системой и просмотра данных.

Границы контекстов: 

- Контекст управления устройствами: Включает в себя функциональность для управления умными устройствами и взаимодействия с ними.
- Контекст мониторинга: Включает сбор и обработку данных с датчиков, а также предоставление актуальной информации пользователям.
- Контекст настройки и подключения: Включает процессы первичной регистрации и настройки устройств, а также взаимодействие с базой данных для их регистрации.
- Контекст взаимодействия с пользователем: Включает все аспекты пользовательского взаимодействия через мобильные и веб-приложения.


### 1.4 Анализ архитектуры монолитного приложения в контексте бизнес-задач компании

Монолитная архитектура системы создаёт значительные ограничения, которые мешают развитию и достижению бизнес-целей компании. Ниже представлен анализ существующих проблем:

#### Основные проблемы монолитного решения

1. Сложность масштабирования: 

    - Рост нагрузки: С увеличением числа пользователей растёт нагрузка на центральный сервер, что приводит к снижению производительности и создаёт узкое место в архитектуре.
    - Отсутствие изолированного масштабирования: Масштабирование отдельных функций, таких как обработка данных с датчиков, невозможно без изменения всей системы. Это делает процесс масштабирования дорогим и неэффективным.

2. Ограниченная гибкость при добавлении новых функций

    - Расширение функционала: Текущая система поддерживает только управление отоплением и мониторинг температуры. Добавление новых устройств, таких как освещение или камеры безопасности, потребует значительных изменений в архитектуре.
    
    - Замедление выхода на рынок: Ограниченная гибкость замедляет развитие продукта и ограничивает возможности компании для выхода на новые рынки с новыми функциями.

3. Зависимость от технических специалистов

    - Подключение новых устройств: Процесс подключения новых устройств требует участия технического специалиста, что увеличивает затраты компании и снижает возможности по расширению клиентской базы.
    
    - Ручная регистрация: Ручная регистрация устройств специалистом замедляет подключение новых домов к системе, что является узким местом в бизнес-процессе компании.

4. Проблемы развёртывания и обновлений

    - Полная остановка системы: Любое обновление требует полной остановки системы, что ведёт к простоям и неудобствам для пользователей.
    
    - Отсутствие непрерывного развёртывания: Отсутствие поддержки непрерывного развёртывания усложняет внедрение новых функций и исправление ошибок, что ограничивает скорость реагирования компании на запросы рынка.

#### Рекомендации по улучшению

1. Переход на микросервисную архитектуру: Для улучшения масштабируемости и гибкости рекомендуется декомпозировать систему на микросервисы, каждый из которых будет отвечать за определённый домен (например, управление устройствами, мониторинг и сбор данных, настройка и подключение).

1. Автоматизация подключения устройств: Разработка API для автоматического подключения новых устройств без участия специалистов позволит существенно сократить затраты и увеличить скорость подключения клиентов.

1. Внедрение асинхронного взаимодействия: Использование асинхронных методов обмена данными (например, с помощью очередей сообщений) позволит повысить производительность системы и улучшить пользовательский опыт.

### 1.5 Диаграмма контекста
Диаграмма контекста монолитной системы представлена на диаграмме [as_is diagram](diagrams/context/as_is.puml)


## Задание 2. Проектирование микросервисной архитектуры
### Декомпозиция приложения на микросервисы
Подробная схема новых микросервисов приведена в диаграмме контейнеров [to_be_container](/diagrams/container/to_be.puml)
Исходя из бизнес-целей компании и выделенных доменов, предлагаю следующую декомпозицию системы на микросервисы:

### Сервис управления пользователями (User Management Service)
- Регистрация и управление учетными записями пользователей.
- Настройка профилей и предпочтений.

Выделение управления пользователями в отдельный сервис упрощает масштабирование системы при росте числа пользователей и позволяет гибко управлять пользовательскими данными независимо от других компонентов системы.

**Домен**: Управление пользователями, включая регистрацию, профили и предпочтения. Основной акцент на обеспечение гибкости и масштабируемости при работе с пользовательскими данными.

### Сервис аутентификации и авторизации (Authentication and Authorization Service)
- Обеспечение безопасности доступа.
- Управление ролями и правами доступа.

Вынесение функций аутентификации и авторизации в отдельный сервис улучшает безопасность, позволяя централизованно управлять доступом и легко интегрировать новые механизмы защиты, что критично для обеспечения безопасности всей системы.

**Домен**: Безопасность и управление доступом. Основной акцент на централизованное управление ролями и правами доступа, обеспечение безопасности и интеграцию современных методов аутентификации.

### Сервис управления устройствами (Device Management Service)
- Регистрация и управление устройствами умного дома.
- Мониторинг состояния устройств.
- Обновление прошивки и конфигурации устройств.

Отдельный сервис для управления устройствами позволяет эффективно масштабировать управление большим количеством устройств и облегчает добавление новых типов устройств без изменения других частей системы.

**Домен**: Управление устройствами умного дома, включая их регистрацию, мониторинг и обновление. Основной акцент на обеспечение масштабируемости и удобного управления большим количеством устройств.

### Сервис управления отоплением (Heating Control Service)
- Управление системами отопления.
- Настройка температурных режимов и расписаний.

Выделение управления отоплением в отдельный сервис позволяет создавать специализированные алгоритмы для энергосбережения и улучшает независимость системы, что облегчает внесение изменений и тестирование этого функционала.

**Домен**: Управление отоплением, включая настройку температурных режимов. Основной акцент на энергоэффективность и независимость настройки системы отопления от других компонентов.

### Сервис управления освещением (Lighting Control Service)
- Контроль осветительных приборов.
- Создание и управление сценами освещения.

Сервис управления освещением позволяет легко интегрировать различные сценарии освещения и улучшает пользовательский опыт, упрощая разработку и тестирование новых сценариев без влияния на другие компоненты системы.

**Домен**: Управление освещением, включая контроль и создание сценариев. Основной акцент на удобство использования и улучшение пользовательского опыта.

### Сервис управления воротами (Gate Control Service)
- Управление автоматическими воротами и дверями.
- Мониторинг состояния замков.

Выделение управления воротами в отдельный сервис повышает безопасность, так как можно централизованно контролировать доступ и легко вносить изменения в логику управления, не затрагивая другие модули.

**Домен**: Управление доступом через ворота и двери. Основной акцент на безопасность и централизованное управление состоянием замков и автоматикой.

### Сервис видеонаблюдения (Surveillance Service)
- Просмотр и запись видео с камер наблюдения.
- Управление доступом к потокам видео.

Сервис видеонаблюдения позволяет обеспечить надежное хранение и обработку видеоданных, а также улучшает масштабируемость, так как можно добавлять новые камеры и управлять ими независимо от других сервисов.

**Домен**: Видеонаблюдение, включая просмотр, запись и управление доступом к камерам. Основной акцент на обеспечение надежности и масштабируемости хранения видеоданных.

### Сервис сценариев и автоматизации (Automation Service)
- Создание пользовательских сценариев и правил автоматизации.
- Интеграция с различными устройствами и сервисами.

Выделение сценариев и автоматизации в отдельный сервис упрощает настройку автоматических действий и позволяет легко добавлять новые сценарии, делая систему более гибкой и настраиваемой под потребности пользователей.

**Домен**: Автоматизация и сценарии. Основной акцент на создание гибких пользовательских правил для автоматизации умного дома.

### Сервис телеметрии (Telemetry Service)
- Сбор и хранение данных от устройств.
- Предоставление аналитики и отчетности.

Отдельный сервис телеметрии позволяет централизованно собирать и анализировать данные, улучшая производительность системы и упрощая реализацию аналитических инструментов для пользователей.

**Домен**: Сбор данных и аналитика. Основной акцент на централизованное хранение данных от устройств и предоставление аналитических отчетов.

### Сервис уведомлений (Notification Service)
- Отправка уведомлений пользователям (push, email, SMS).
- Настройка правил и триггеров уведомлений.

Сервис уведомлений позволяет централизовать отправку уведомлений и настроек триггеров, что делает систему более гибкой и удобной для управления взаимодействием с пользователями.

**Домен**: Уведомления и оповещения. Основной акцент на гибкость настройки уведомлений и управление взаимодействием с пользователями.

### API Gateway
- Единая точка входа для клиентских приложений.
- Маршрутизация запросов к соответствующим микросервисам.
- Обеспечение безопасности и лимитирования запросов.

Использование API Gateway упрощает взаимодействие клиентских приложений с системой, обеспечивая единое место для маршрутизации и контроля безопасности запросов, что улучшает производительность и безопасность.

**Домен**: Входная точка системы. Основной акцент на маршрутизацию, безопасность и лимитирование запросов от клиентских приложений.

### Шина данных (Kafka)
- Обеспечение асинхронного обмена сообщениями между микросервисами.
- Обработка событий в реальном времени.

Использование шины данных позволяет эффективно обрабатывать события в реальном времени и улучшает взаимодействие между микросервисами, обеспечивая надежный и масштабируемый обмен сообщениями.

**Домен**: Обмен сообщениями и события в реальном времени. Основной акцент на асинхронную коммуникацию и масштабируемость обработки событий.


### Примечание
Практически все сервисы имееют свою бд, в которой будет храниться локальная информация сервиса и вестись лог состояний.

## Взаимодействие между компонентами системы

### Взаимодействие между микросервисами
Микросервисы взаимодействуют друг с другом как синхронно, так и асинхронно. Для синхронного взаимодействия используется прямой вызов API, что позволяет мгновенно получить нужную информацию. Для асинхронного взаимодействия применяется шина данных (Kafka), обеспечивающая обмен сообщениями в реальном времени. Асинхронное взаимодействие помогает справляться с нагрузками и обеспечивает гибкость системы, позволяя микросервисам оставаться независимыми друг от друга.

### API Gateway
API Gateway служит единой точкой входа для клиентских приложений, маршрутизируя запросы к нужным микросервисам. Он обрабатывает аутентификацию, авторизацию и обеспечивает балансировку нагрузки, таким образом улучшая безопасность и производительность всей системы. Клиентские приложения никогда не обращаются напрямую к микросервисам, что упрощает управление и защиту всех коммуникаций.

### Шина данных (Kafka)
Шина данных используется для обмена событиями и сообщениями между микросервисами. Kafka позволяет микросервисам подписываться на события и реагировать на них, что особенно важно для таких задач, как сбор телеметрии, обработка событий видеонаблюдения, или генерация уведомлений. Благодаря Kafka микросервисы могут реагировать на изменения и обмениваться данными в режиме реального времени, что делает систему более отзывчивой и эффективной.

## Диаграмма компонентов (TO_BE)
На примере сервисов контроля освещения, управления воротами и сервиса нотификаций реализована диграмма компонентов [to_be_component](/diagrams/component/to_be.puml)


## Пример визуализации на уровне кода
В качестве сервисов для С4 Code диаграммы были выбраны:
 - Сервис аутентицификации и авторизации [auth](/diagrams/code/auth.puml)
 - Сервис телеметрии [telemetry](/diagrams/code/telemetry.puml)

## Задание 3. Разработка ER диаграммы:
### Определение ключевых сущностей и моделирование их взаимосвязей

На основе анализа предметной области и спроектированных микросервисов для системы «Тёплый дом» были идентифицированы ключевые сущности. Ниже представлены эти сущности с их атрибутами и описаниями взаимосвязей между ними.
Пример можно увидеть в диаграмме [entites](/diagrams/er/entities.puml)

### Идентификация сущностей и их атрибутов
#### 1. Пользователь (User)
**Описание**: Представляет конечного пользователя системы, который может управлять устройствами и сценариями в своих домах.

**Атрибуты**:
- **id**: UUID — уникальный идентификатор пользователя.
- **username**: String — уникальное имя пользователя.
- **email**: String — адрес электронной почты.
- **password_hash**: String — хеш пароля.
- **first_name**: String — имя.
- **last_name**: String — фамилия.
- **phone_number**: String — номер телефона.
- **created_at**: Timestamp — дата и время создания аккаунта.
- **updated_at**: Timestamp — дата и время последнего обновления информации.
- **status**: Enum (ACTIVE, INACTIVE, SUSPENDED) — статус аккаунта.

#### 2. Дом (House)
**Описание**: Представляет физический дом или помещение, которым владеет или управляет пользователь.

**Атрибуты**:
- **id**: UUID — уникальный идентификатор дома.
- **user_id**: UUID — внешний ключ к пользователю (владелец дома).
- **address**: String — адрес дома.
- **name**: String — название или описание дома (например, «Загородный дом»).
- **created_at**: Timestamp — дата и время создания записи.
- **updated_at**: Timestamp — дата и время последнего обновления.

#### 3. Устройство (Device)
**Описание**: Представляет отдельное умное устройство, установленное в доме.

**Атрибуты**:
- **id**: UUID — уникальный идентификатор устройства.
- **house_id**: UUID — внешний ключ к дому, где установлено устройство.
- **type_id**: UUID — внешний ключ к типу устройства.
- **serial_number**: String — серийный номер устройства.
- **name**: String — пользовательское название устройства (например, «Термостат в гостиной»).
- **location**: String — местоположение устройства в доме.
- **status**: Enum (ONLINE, OFFLINE, ERROR) — текущее состояние устройства.
- **firmware_version**: String — версия прошивки устройства.
- **configuration**: JSON — текущая конфигурация устройства.
- **created_at**: Timestamp — дата и время добавления устройства.
- **updated_at**: Timestamp — дата и время последнего обновления.

#### 4. Тип устройства (DeviceType)
**Описание**: Определяет категорию или модель устройства.

**Атрибуты**:
- **id**: UUID — уникальный идентификатор типа устройства.
- **name**: String — название типа устройства (например, «Термостат»).
- **manufacturer**: String — производитель устройства.
- **model**: String — модель устройства.
- **supported_features**: JSON — список поддерживаемых функций.
- **description**: String — описание типа устройства.

#### 5. Модуль (Module)
**Описание**: Представляет функциональный модуль системы, который может быть установлен на устройство или использоваться в сценариях автоматизации.

**Атрибуты**:
- **id**: UUID — уникальный идентификатор модуля.
- **name**: String — название модуля.
- **version**: String — версия модуля.
- **description**: String — описание функциональности модуля.
- **created_at**: Timestamp — дата создания модуля.
- **updated_at**: Timestamp — дата последнего обновления.

#### 6. Телеметрия (TelemetryData)
**Описание**: Хранит данные, собранные с устройств (например, температура, влажность).

**Атрибуты**:
- **id**: UUID — уникальный идентификатор записи телеметрии.
- **device_id**: UUID — внешний ключ к устройству.
- **timestamp**: Timestamp — время сбора данных.
- **data_type**: String — тип данных (например, «temperature»).
- **value**: Float/String — значение измерения.
- **unit**: String — единица измерения (например, «°C»).
- **raw_data**: JSON — необработанные данные или дополнительные параметры.

#### 7. Сценарий (Scenario)
**Описание**: Представляет пользовательский сценарий автоматизации.

**Атрибуты**:
- **id**: UUID — уникальный идентификатор сценария.
- **user_id**: UUID — внешний ключ к пользователю, создавшему сценарий.
- **name**: String — название сценария.
- **description**: String — описание сценария.
- **trigger_condition**: JSON — условия срабатывания сценария.
- **is_active**: Boolean — статус активности сценария.
- **created_at**: Timestamp — дата создания.
- **updated_at**: Timestamp — дата последнего обновления.

#### 8. Действие (Action)
**Описание**: Определяет отдельное действие в рамках сценария.

**Атрибуты**:
- **id**: UUID — уникальный идентификатор действия.
- **scenario_id**: UUID — внешний ключ к сценарию.
- **device_id**: UUID — внешний ключ к устройству, на которое направлено действие.
- **action_type**: String — тип действия (например, «TURN_ON», «SET_TEMPERATURE»).
- **parameters**: JSON — дополнительные параметры действия.
- **sequence_order**: Integer — порядок выполнения действия в сценарии.

#### 9. Событие (Event)
**Описание**: Представляет событие, произошедшее в системе или на устройстве.

**Атрибуты**:
- **id**: UUID — уникальный идентификатор события.
- **device_id**: UUID — внешний ключ к устройству (может быть null, если событие системное).
- **event_type**: String — тип события (например, «DEVICE_ONLINE», «TEMPERATURE_THRESHOLD_EXCEEDED»).
- **timestamp**: Timestamp — время события.
- **data**: JSON — дополнительные данные события.
- **processed**: Boolean — флаг обработки события.

#### 10. Уведомление (Notification)
**Описание**: Представляет уведомление, отправленное пользователю.

**Атрибуты**:
- **id**: UUID — уникальный идентификатор уведомления.
- **user_id**: UUID — внешний ключ к пользователю.
- **event_id**: UUID — внешний ключ к событию, вызвавшему уведомление.
- **message**: String — текст уведомления.
- **sent_at**: Timestamp — время отправки.
- **delivery_method**: Enum (EMAIL, SMS, PUSH) — способ доставки.
- **status**: Enum (SENT, FAILED, PENDING) — статус отправки.

### Описание связей между сущностями

#### Пользователь — Дом
**Связь**: Один пользователь может владеть или управлять несколькими домами.
**Отношение**: Один-ко-многим (User 1 — * House).

#### Дом — Устройство
**Связь**: Один дом может содержать множество устройств.
**Отношение**: Один-ко-многим (House 1 — * Device).

#### Устройство — Тип устройства
**Связь**: Каждое устройство относится к определенному типу устройства.
**Отношение**: Многим-к-одному (Device * — 1 DeviceType).

#### Устройство — Телеметрия
**Связь**: Одно устройство генерирует множество записей телеметрии.
**Отношение**: Один-ко-многим (Device 1 — * TelemetryData).

#### Пользователь — Сценарий
**Связь**: Пользователь может создавать несколько сценариев автоматизации.
**Отношение**: Один-ко-многим (User 1 — * Scenario).

#### Сценарий — Действие
**Связь**: Сценарий может содержать несколько действий.
**Отношение**: Один-ко-многим (Scenario 1 — * Action).

#### Действие — Устройство
**Связь**: Действие направлено на конкретное устройство.
**Отношение**: Многим-к-одному (Action * — 1 Device).

#### Устройство — Событие
**Связь**: Устройство может генерировать множество событий.
**Отношение**: Один-ко-многим (Device 1 — * Event).

#### Событие — Уведомление
**Связь**: Событие может вызвать несколько уведомлений для разных пользователей.
**Отношение**: Один-ко-многим (Event 1 — * Notification).

#### Пользователь — Уведомление:

**Связь**: Пользователь может получать множество уведомлений.
**Отношение**: Один-ко-многим (User 1 — * Notification).

#### Модуль — Устройство:
**Связь**: Модуль может быть установлен на несколько устройств, и устройство может поддерживать несколько модулей.
**Отношение**: Многие-ко-многим (Module * — * Device).
**Реализация**: Посредством связующей таблицы (DeviceModule), содержащей device_id и module_id.


Представленная логическая модель базы данных включает в себя основные сущности системы «Тёплый дом» и отражает их взаимосвязи. Эта модель послужит основой для дальнейшего проектирования физической схемы базы данных и реализации бизнес-логики в микросервисах. Она обеспечивает гибкость и расширяемость системы, позволяя легко добавлять новые функции и поддерживать требования бизнеса.